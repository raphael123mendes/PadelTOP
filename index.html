<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Padel Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f0d;
    --surface: #111a14;
    --surface2: #1a2820;
    --border: #243320;
    --accent: #5aff7e;
    --accent2: #ff5a5a;
    --accent3: #ffd95a;
    --text: #e8f5e8;
    --text2: #7a9e7a;
    --radius: 16px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  h1,h2,h3,h4 { font-family: 'Syne', sans-serif; }
  .app { max-width: 480px; margin: 0 auto; padding: 0 0 90px; }

  .header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 14px 20px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo { display: flex; align-items: center; gap: 10px; }
  .header-logo .court-icon { width: 34px; height: 34px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 17px; }
  .header-logo h1 { font-size: 19px; color: var(--text); letter-spacing: -0.5px; }
  .header-user { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text2); }
  .avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--surface2); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: var(--accent); }
  .btn-ghost { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 13px; padding: 6px 10px; border-radius: 8px; transition: background .2s; }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }

  .page { display: none; padding: 20px; animation: fadeIn .3s; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:none; } }

  .login-hero { text-align: center; padding: 40px 0 28px; }
  .login-hero .big-court { width: 76px; height: 76px; background: linear-gradient(135deg, var(--accent), #2adf5a); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 38px; margin-bottom: 18px; box-shadow: 0 0 40px rgba(90,255,126,0.25); }
  .login-hero h2 { font-size: 30px; color: var(--text); margin-bottom: 6px; }
  .login-hero p { color: var(--text2); font-size: 14px; line-height: 1.5; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 14px; }
  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 7px; }
  .field input { width: 100%; padding: 11px 13px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; transition: border-color .2s; }
  .field input:focus { border-color: var(--accent); }
  .btn { width: 100%; padding: 13px; border: none; border-radius: 10px; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: all .2s; letter-spacing: .3px; }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(90,255,126,0.3); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--accent2); color: #fff; }
  .divider { text-align: center; color: var(--text2); font-size: 12px; margin: 10px 0; }

  .tabs { display: flex; gap: 4px; background: var(--surface); padding: 4px; border-radius: 12px; margin-bottom: 18px; }
  .tab { flex: 1; padding: 9px; border: none; border-radius: 9px; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; transition: all .2s; background: none; color: var(--text2); }
  .tab.active { background: var(--accent); color: var(--bg); }

  .num-players { display: flex; gap: 8px; margin-bottom: 14px; }
  .num-btn { flex: 1; padding: 11px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; color: var(--text2); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: all .2s; }
  .num-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(90,255,126,0.07); }
  .section-title { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

  .game-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 9px; transition: border-color .2s; }
  .game-card.scored { border-color: rgba(90,255,126,0.3); }
  .game-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .game-num { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .round-badge { font-size: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 2px 8px; color: var(--text2); }
  .teams { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 6px; }
  .team { text-align: center; }
  .team-name { font-size: 13px; font-weight: 500; color: var(--text); line-height: 1.3; }
  .vs { font-family: 'Syne', sans-serif; font-size: 11px; color: var(--text2); font-weight: 700; }
  .score-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
  .score-input { width: 50px; height: 42px; text-align: center; font-size: 20px; font-weight: 700; font-family: 'Syne', sans-serif; background: var(--bg); border: 1.5px solid var(--border); border-radius: 8px; color: var(--text); outline: none; transition: border-color .2s; -moz-appearance: textfield; }
  .score-input::-webkit-inner-spin-button, .score-input::-webkit-outer-spin-button { -webkit-appearance: none; }
  .score-input:focus { border-color: var(--accent); }
  .score-sep { font-size: 18px; color: var(--text2); font-weight: 700; }
  .resting { font-size: 11px; color: var(--text2); text-align: center; margin-top: 7px; }

  .lb-section-title { font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin: 18px 0 10px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
  .lb-row { display: flex; align-items: center; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 11px 14px; margin-bottom: 7px; gap: 10px; }
  .lb-row:first-child { border-color: rgba(255,217,90,.4); }
  .lb-row:nth-child(2) { border-color: rgba(200,200,200,.25); }
  .lb-row:nth-child(3) { border-color: rgba(200,130,50,.3); }
  .lb-rank { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 800; width: 24px; text-align: center; color: var(--text2); }
  .lb-row:first-child .lb-rank { color: var(--accent3); }
  .lb-info { flex: 1; min-width: 0; }
  .lb-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .lb-sub { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .lb-pts { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--accent); }
  .lb-pts-label { font-size: 10px; color: var(--text2); text-align: right; }

  .history-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color .2s; }
  .history-card:hover { border-color: var(--accent); }
  .history-date { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; }
  .history-meta { font-size: 12px; color: var(--text2); margin-top: 3px; }
  .history-players { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 9px; }
  .player-chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 2px 9px; font-size: 11px; color: var(--text); }
  .history-winner { display: flex; align-items: center; gap: 5px; margin-top: 8px; font-size: 12px; color: var(--accent3); }
  .session-label { font-size: 11px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 2px 8px; color: var(--text2); }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-bottom: 4px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 13px; text-align: center; }
  .stat-val { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; color: var(--accent); }
  .stat-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .6px; margin-top: 3px; }

  .draft-banner { background: rgba(90,255,126,0.07); border: 1px solid rgba(90,255,126,0.25); border-radius: 14px; padding: 14px; margin-bottom: 16px; }
  .draft-banner-title { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 3px; }
  .draft-banner-meta { font-size: 12px; color: var(--text2); margin-bottom: 11px; }
  .draft-actions { display: flex; gap: 8px; }
  .draft-actions .btn { padding: 9px 0; font-size: 13px; }

  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.75); display: flex; align-items: flex-end; justify-content: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity .3s; }
  .overlay.show { opacity: 1; pointer-events: all; }
  .modal-sheet { background: var(--surface); border: 1px solid var(--border); border-radius: 22px 22px 0 0; padding: 22px 20px 44px; width: 100%; max-width: 480px; transform: translateY(100%); transition: transform .3s; max-height: 82vh; overflow-y: auto; }
  .overlay.show .modal-sheet { transform: none; }
  .modal-handle { width: 38px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 14px; }
  .modal-actions { display: flex; gap: 9px; margin-top: 14px; }
  .modal-actions .btn { flex: 1; }

  .toast { position: fixed; bottom: 88px; left: 50%; transform: translateX(-50%) translateY(16px); background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 9px 18px; font-size: 13px; color: var(--text); opacity: 0; transition: all .3s; pointer-events: none; white-space: nowrap; z-index: 200; max-width: 90vw; overflow: hidden; text-overflow: ellipsis; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--accent); color: var(--accent); }
  .toast.error { border-color: var(--accent2); color: var(--accent2); }

  .empty { text-align: center; padding: 44px 20px; color: var(--text2); }
  .empty h3 { font-size: 17px; margin-bottom: 7px; color: var(--text); }
  .spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 32px; color: var(--text2); }
  .chip { display: inline-block; background: rgba(90,255,126,0.1); color: var(--accent); border: 1px solid rgba(90,255,126,0.25); border-radius: 20px; padding: 2px 9px; font-size: 11px; }
  .flex-between { display: flex; justify-content: space-between; align-items: center; }
  .action-row { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .action-row .btn { flex: 1; padding: 9px 4px; font-size: 12px; min-width: 60px; }
</style>
</head>
<body>

<div class="header" id="app-header" style="display:none">
  <div class="header-logo">
    <div class="court-icon">üéæ</div>
    <h1>Padel Manager</h1>
  </div>
  <div class="header-user">
    <span id="header-username"></span>
    <div class="avatar" id="header-avatar"></div>
    <button class="btn-ghost" onclick="logout()">Out</button>
  </div>
</div>

<div class="app">

  <!-- LOGIN -->
  <div class="page active" id="page-login">
    <div class="login-hero">
      <div class="big-court">üéæ</div>
      <h2>Padel Manager</h2>
      <p>Track your group's round robin games,<br>scores and rankings.</p>
    </div>
    <div class="card" id="login-form">
      <div class="field">
        <label>Username</label>
        <input type="text" id="login-username" placeholder="e.g. carlos" autocomplete="username">
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <div class="field" id="token-field">
        <label>GitHub Token <span style="color:var(--accent);font-size:10px;text-transform:none;letter-spacing:0">‚Äî only needed on first login per device</span></label>
        <input type="password" id="login-token" placeholder="github_pat_..." autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="doLogin()">Sign In</button>
      <div class="divider">‚Äî or ‚Äî</div>
      <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
    </div>
    <div class="card" id="register-form" style="display:none">
      <h3 style="margin-bottom:14px;font-size:15px">Create Account</h3>
      <div class="field"><label>Display Name</label><input type="text" id="reg-name" placeholder="Your name"></div>
      <div class="field"><label>Username</label><input type="text" id="reg-username" placeholder="lowercase, no spaces"></div>
      <div class="field"><label>Password</label><input type="password" id="reg-password" placeholder="Min 6 characters"></div>
      <button class="btn btn-primary" onclick="doRegister()">Create Account</button>
      <div class="divider"></div>
      <button class="btn-ghost" style="width:100%;text-align:center" onclick="showLogin()">‚Üê Back to Sign In</button>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="page" id="page-app">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('today')" id="tab-today">Today</button>
      <button class="tab" onclick="switchTab('board')" id="tab-board">Leaderboard</button>
      <button class="tab" onclick="switchTab('history')" id="tab-history">History</button>
    </div>

    <!-- TODAY -->
    <div id="view-today" class="tab-view">
      <div id="resume-banner" style="display:none" class="draft-banner">
        <div class="draft-banner-title">üìã Draft in progress</div>
        <div id="resume-meta" class="draft-banner-meta"></div>
        <div class="draft-actions">
          <button class="btn btn-primary" onclick="resumeDraft()">Resume Session</button>
          <button class="btn btn-secondary" onclick="discardDraft()">Discard</button>
        </div>
      </div>
      <div id="setup-panel">
        <p class="section-title">Number of Players</p>
        <div class="num-players">
          <button class="num-btn selected" onclick="selectNumPlayers(4)" id="np-4">4 Players</button>
          <button class="num-btn" onclick="selectNumPlayers(5)" id="np-5">5 Players</button>
        </div>
        <div class="field">
          <label>Player Names (comma separated)</label>
          <input type="text" id="player-names" placeholder="Carlos, Ana, Migs, Laura">
        </div>
        <button class="btn btn-primary" onclick="generateGames()">Generate Games</button>
      </div>
      <div id="games-panel" style="display:none">
        <div class="action-row" style="margin-top:4px">
          <button class="btn btn-secondary" onclick="saveDraft()">üìã Draft</button>
          <button class="btn btn-secondary" onclick="saveSession()">üíæ Save</button>
          <button class="btn btn-secondary" onclick="exportCSV()">üì• CSV</button>
          <button class="btn btn-secondary" onclick="confirmReset()">‚Ü∫ Reset</button>
        </div>
        <div id="game-list"></div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="view-board" class="tab-view" style="display:none">
      <div id="board-content">
        <div class="empty"><h3>No active session</h3><p>Generate games in Today tab</p></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="view-history" class="tab-view" style="display:none">
      <div id="history-content">
        <div class="loading"><div class="spinner"></div> Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- RESET MODAL -->
<div class="overlay" id="reset-overlay" onclick="closeModal('reset-overlay')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Reset session?</div>
    <p style="color:var(--text2);font-size:13px">Clears the current session from your device. Saved sessions in history are not affected.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('reset-overlay')">Cancel</button>
      <button class="btn btn-danger" onclick="doReset()">Reset</button>
    </div>
  </div>
</div>

<!-- HISTORY DETAIL MODAL -->
<div class="overlay" id="history-overlay" onclick="closeModal('history-overlay')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div id="history-detail-content"></div>
    <div class="modal-actions" style="margin-top:16px">
      <button class="btn btn-secondary" onclick="closeModal('history-overlay')">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
//  ‚öôÔ∏è  CONFIGURATION ‚Äî owner/repo hardcoded, token per-device
// ============================================================
const GITHUB_OWNER = 'raphael123mendes';
const GITHUB_REPO  = 'PadelTOP';
const GITHUB_FILE  = 'padel-data.json';
let   GITHUB_TOKEN = localStorage.getItem('padel_token') || '';
// ============================================================

let currentUser = null;
let githubData  = null;
let fileSha     = null;

const state = {
  players: [], numPlayers: 4, games: [], scores: {}, sessionId: null
};

window.onload = () => {
  // Hide token field if already saved on this device
  if (GITHUB_TOKEN) {
    document.getElementById('token-field').style.display = 'none';
  }
  const saved = localStorage.getItem('padel_user');
  if (saved) { currentUser = JSON.parse(saved); initApp(); }
};

// ---- GITHUB ----
async function githubGet() {
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
  try {
    const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}`, Accept: 'application/vnd.github.v3+json' } });
    if (res.status === 401) { toast('GitHub token invalid or expired', 'error'); return null; }
    if (res.status === 403) { toast('Token has no permission for this repo', 'error'); return null; }
    if (res.status === 404) { toast('padel-data.json not found in repo', 'error'); return null; }
    if (!res.ok) { toast(`GitHub error ${res.status}`, 'error'); return null; }
    const json = await res.json();
    fileSha = json.sha;
    return JSON.parse(atob(json.content.replace(/\n/g, '')));
  } catch(e) { toast('Network error: ' + e.message, 'error'); return null; }
}

async function githubPut(data) {
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
  try {
    const res = await fetch(url, {
      method: 'PUT',
      headers: { Authorization: `token ${GITHUB_TOKEN}`, Accept: 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'padel: update data', content, sha: fileSha })
    });
    if (res.status === 401) { toast('Token invalid or expired', 'error'); return false; }
    if (res.status === 403) { toast('Token needs Contents: Read & Write', 'error'); return false; }
    if (res.status === 422) { toast('Conflict ‚Äî reload page and try again', 'error'); return false; }
    if (!res.ok) { const e = await res.json().catch(()=>({})); toast(`Save failed: ${e.message||res.status}`, 'error'); return false; }
    const json = await res.json();
    fileSha = json.content.sha;
    return true;
  } catch(e) { toast('Network error: ' + e.message, 'error'); return false; }
}

// ---- AUTH ----
async function doLogin() {
  const username = document.getElementById('login-username').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  if (!username || !password) { toast('Enter username and password', 'error'); return; }

  // Save token if provided
  const tokenInput = document.getElementById('login-token').value.trim();
  if (tokenInput) {
    GITHUB_TOKEN = tokenInput;
    localStorage.setItem('padel_token', tokenInput);
  }
  if (!GITHUB_TOKEN) { toast('Enter your GitHub token on first login', 'error'); return; }

  toast('Signing in‚Ä¶');
  const data = await githubGet();
  if (!data) return;
  githubData = data;
  const user = data.users[username];
  if (!user) { toast('User not found', 'error'); return; }
  if (user.password !== hashPw(password)) { toast('Wrong password', 'error'); return; }
  currentUser = { username, name: user.name };
  localStorage.setItem('padel_user', JSON.stringify(currentUser));
  initApp();
}

async function doRegister() {
  const name     = document.getElementById('reg-name').value.trim();
  const username = document.getElementById('reg-username').value.trim().toLowerCase().replace(/\s/g,'');
  const password = document.getElementById('reg-password').value;
  if (!name || !username || !password) { toast('Fill all fields', 'error'); return; }
  if (password.length < 6) { toast('Password must be 6+ characters', 'error'); return; }
  if (!GITHUB_TOKEN) { toast('Enter your GitHub token on the Sign In page first', 'error'); return; }
  toast('Creating account‚Ä¶');
  const data = await githubGet();
  if (!data) return;
  githubData = data;
  if (data.users[username]) { toast('Username already taken', 'error'); return; }
  data.users[username] = { name, password: hashPw(password), createdAt: new Date().toISOString() };
  const ok = await githubPut(data);
  if (!ok) return;
  toast('Account created! Sign in ‚úì', 'success');
  showLogin();
  document.getElementById('login-username').value = username;
}

function hashPw(pw) {
  let h = 0;
  for (let i = 0; i < pw.length; i++) h = Math.imul(31, h) + pw.charCodeAt(i) | 0;
  return 'h' + Math.abs(h).toString(36);
}

function logout() {
  localStorage.removeItem('padel_user');
  localStorage.removeItem('padel_session');
  currentUser = null;
  document.getElementById('page-login').classList.add('active');
  document.getElementById('page-app').classList.remove('active');
  document.getElementById('app-header').style.display = 'none';
  // Keep token saved ‚Äî no need to re-enter on same device
  document.getElementById('token-field').style.display = 'none';
  showLogin();
}

function showRegister() { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; }
function showLogin()    { document.getElementById('login-form').style.display='block'; document.getElementById('register-form').style.display='none'; }

function initApp() {
  document.getElementById('page-login').classList.remove('active');
  document.getElementById('page-app').classList.add('active');
  document.getElementById('app-header').style.display = 'flex';
  document.getElementById('header-username').textContent = currentUser.name;
  document.getElementById('header-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
  const saved = localStorage.getItem('padel_session');
  if (saved) {
    Object.assign(state, JSON.parse(saved));
    if (state.games.length > 0) { showGamesPanel(); renderGames(); }
  }
  loadHistory();
}

// ---- GAME LOGIC ----
function selectNumPlayers(n) {
  state.numPlayers = n;
  document.getElementById('np-4').classList.toggle('selected', n===4);
  document.getElementById('np-5').classList.toggle('selected', n===5);
}

function generateGames() {
  const players = document.getElementById('player-names').value.split(',').map(p=>p.trim()).filter(Boolean);
  if (players.length !== state.numPlayers) { toast(`Enter exactly ${state.numPlayers} names`, 'error'); return; }
  state.players = players; state.scores = {}; state.sessionId = null;
  state.numPlayers === 4 ? genSchedule4() : genSchedule5();
  showGamesPanel(); renderGames(); saveLocal();
}

function genSchedule4() {
  const p = state.players;
  const pairs = [[[p[0],p[1]],[p[2],p[3]]],[[p[0],p[2]],[p[1],p[3]]],[[p[0],p[3]],[p[1],p[2]]]].sort(()=>Math.random()-.5);
  state.games = [];
  for (let i=0;i<15;i++) { const g=pairs[i%3]; state.games.push({id:i+1,doubleA:g[0],doubleB:g[1],resting:null,round:Math.floor(i/3)+1}); }
}

function genSchedule5() {
  const p = state.players;
  const base = [{a:[1,2],b:[3,4],r:5},{a:[2,3],b:[4,5],r:1},{a:[1,4],b:[3,5],r:2},{a:[1,5],b:[2,4],r:3},{a:[1,3],b:[2,5],r:4},{a:[2,3],b:[1,4],r:5},{a:[2,4],b:[3,5],r:1},{a:[3,4],b:[1,5],r:2},{a:[1,2],b:[4,5],r:3},{a:[2,3],b:[1,5],r:4},{a:[1,3],b:[2,4],r:5},{a:[3,4],b:[2,5],r:1},{a:[1,3],b:[4,5],r:2},{a:[1,4],b:[2,5],r:3},{a:[1,2],b:[3,5],r:4}];
  state.games = base.map((g,i)=>({id:i+1,doubleA:[p[g.a[0]-1],p[g.a[1]-1]],doubleB:[p[g.b[0]-1],p[g.b[1]-1]],resting:p[g.r-1],round:Math.floor(i/3)+1}));
}

function calcLeaderboard() {
  const ps = {}; const ds = {};
  state.players.forEach(p => ps[p]={pts:0,played:0,won:0,lost:0});
  state.games.forEach(game => {
    const sc = state.scores[game.id];
    if (!sc) return;
    const pts = sc.split(':');
    if (pts[0]===''||pts[1]==='') return;
    const a=Number(pts[0]), b=Number(pts[1]);
    if (isNaN(a)||isNaN(b)) return;
    game.doubleA.forEach(p=>{ps[p].pts+=a;ps[p].played++;ps[p].won+=a;ps[p].lost+=b;});
    game.doubleB.forEach(p=>{ps[p].pts+=b;ps[p].played++;ps[p].won+=b;ps[p].lost+=a;});
    const kA=[...game.doubleA].sort().join(' & '), kB=[...game.doubleB].sort().join(' & ');
    if(!ds[kA])ds[kA]={pts:0,played:0,won:0,lost:0};
    if(!ds[kB])ds[kB]={pts:0,played:0,won:0,lost:0};
    ds[kA].pts+=a;ds[kA].played++;ds[kA].won+=a;ds[kA].lost+=b;
    ds[kB].pts+=b;ds[kB].played++;ds[kB].won+=b;ds[kB].lost+=a;
  });
  const players = Object.entries(ps).map(([name,s])=>({name,pts:s.pts,played:s.played,avg:s.played?(s.pts/s.played).toFixed(1):'-',diff:s.won-s.lost})).sort((a,b)=>b.pts-a.pts||b.diff-a.diff);
  const doubles = Object.entries(ds).map(([pair,s])=>({pair,pts:s.pts,played:s.played,avgPts:s.played?(s.pts/s.played).toFixed(1):'-',diff:s.won-s.lost})).sort((a,b)=>b.pts-a.pts||b.diff-a.diff);
  return {players,doubles};
}

// ---- RENDER ----
function showGamesPanel() {
  document.getElementById('setup-panel').style.display='none';
  document.getElementById('games-panel').style.display='block';
}

function renderGames() {
  const el = document.getElementById('game-list');
  el.innerHTML = '';
  state.games.forEach(game => {
    const sc = state.scores[game.id]||'';
    const parts = sc.split(':');
    const sa=parts[0]??'', sb=parts[1]??'';
    const scored = sa!==''&&sb!=='';
    el.innerHTML += `<div class="game-card ${scored?'scored':''}" id="gc-${game.id}">
      <div class="game-meta"><span class="game-num">Game ${game.id}</span><span class="round-badge">Round ${game.round||''}</span></div>
      <div class="teams">
        <div class="team"><div class="team-name">${game.doubleA.join('<br>')}</div></div>
        <div class="vs">VS</div>
        <div class="team"><div class="team-name">${game.doubleB.join('<br>')}</div></div>
      </div>
      <div class="score-row">
        <input type="number" class="score-input" id="sa-${game.id}" value="${sa}" placeholder="0" min="0" oninput="onScore(${game.id})">
        <span class="score-sep">:</span>
        <input type="number" class="score-input" id="sb-${game.id}" value="${sb}" placeholder="0" min="0" oninput="onScore(${game.id})">
      </div>
      ${game.resting?`<div class="resting">ü™ë ${game.resting} resting</div>`:''}
    </div>`;
  });
  renderBoard();
}

function onScore(id) {
  const a=document.getElementById(`sa-${id}`).value, b=document.getElementById(`sb-${id}`).value;
  state.scores[id]=`${a}:${b}`;
  document.getElementById(`gc-${id}`).classList.toggle('scored',a!==''&&b!=='');
  saveLocal(); renderBoard();
}

function renderBoard() {
  const {players,doubles} = calcLeaderboard();
  const el = document.getElementById('board-content');
  const scored = Object.values(state.scores).filter(s=>{const[a,b]=s.split(':');return a!==''&&b!=='';}).length;
  el.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val">${scored}</div><div class="stat-label">Scored</div></div>
      <div class="stat-card"><div class="stat-val">${state.games.length-scored}</div><div class="stat-label">Remaining</div></div>
    </div>
    <div class="lb-section-title">üë§ Individual Ranking</div>
    ${players.map((p,i)=>`<div class="lb-row"><div class="lb-rank">${i+1}</div><div class="lb-info"><div class="lb-name">${p.name}</div><div class="lb-sub">${p.played} games ¬∑ avg ${p.avg} ¬∑ diff ${p.diff>0?'+':''}${p.diff}</div></div><div><div class="lb-pts">${p.pts}</div><div class="lb-pts-label">pts</div></div></div>`).join('')}
    ${doubles.length?`<div class="lb-section-title">ü§ù Best Doubles</div>${doubles.map((d,i)=>`<div class="lb-row"><div class="lb-rank">${i+1}</div><div class="lb-info"><div class="lb-name">${d.pair}</div><div class="lb-sub">${d.played} games ¬∑ avg ${d.avgPts} pts/game ¬∑ diff ${d.diff>0?'+':''}${d.diff}</div></div><div><div class="lb-pts">${d.pts}</div><div class="lb-pts-label">pts</div></div></div>`).join('')}`:''}`;
}

// ---- SAVE SESSION ----
async function saveSession() {
  const entered = Object.values(state.scores).filter(s=>{const[a,b]=s.split(':');return a!==''&&b!=='';}).length;
  if (entered===0) { toast('Enter at least one score first','error'); return; }
  toast('Saving‚Ä¶');
  let data = githubData;
  if (!data) data = await githubGet();
  if (!data) return;
  githubData = data;
  if (!data.sessions) data.sessions=[];

  const {players:lb, doubles:dlb} = calcLeaderboard();
  const today = new Date().toISOString().slice(0,10);

  // Update existing session
  if (state.sessionId) {
    const idx = data.sessions.findIndex(s=>s.id===state.sessionId);
    if (idx>=0) {
      data.sessions[idx] = {...data.sessions[idx], savedBy:currentUser.username, savedAt:new Date().toISOString(), scores:state.scores, leaderboard:lb, doublesLeaderboard:dlb};
      if (await githubPut(data)) { githubData=data; toast('Session updated ‚úì','success'); renderHistoryList(data.sessions); }
      return;
    }
  }

  // New session ‚Äî count same-day same-players sessions for label
  const sameDay = data.sessions.filter(s=>s.date===today&&JSON.stringify([...s.players].sort())===JSON.stringify([...state.players].sort()));
  const sessionNum = sameDay.length+1;
  const session = {
    id: Date.now().toString(), date: today,
    sessionNum, label: sessionNum>1?`Session ${sessionNum}`:null,
    savedBy: currentUser.username, savedAt: new Date().toISOString(),
    players: state.players, numPlayers: state.numPlayers,
    games: state.games, scores: state.scores,
    leaderboard: lb, doublesLeaderboard: dlb
  };
  state.sessionId = session.id; saveLocal();
  data.sessions.unshift(session);
  if (await githubPut(data)) { githubData=data; toast('Saved to GitHub ‚úì','success'); renderHistoryList(data.sessions); }
}

// ---- DRAFT ----
async function saveDraft() {
  if (state.games.length===0) { toast('No active session','error'); return; }
  toast('Saving draft‚Ä¶');
  let data=githubData; if(!data) data=await githubGet(); if(!data) return;
  githubData=data;
  data.draft = { savedBy:currentUser.username, savedAt:new Date().toISOString(), players:state.players, numPlayers:state.numPlayers, games:state.games, scores:state.scores, sessionId:state.sessionId||null };
  if (await githubPut(data)) { githubData=data; toast('Draft saved ‚úì ‚Äî anyone can resume next time!','success'); }
}

async function checkForDraft(data) {
  if (!data||!data.draft) return;
  const d=data.draft;
  const date=new Date(d.savedAt).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
  const scored=Object.values(d.scores||{}).filter(s=>{const[a,b]=s.split(':');return a!==''&&b!=='';}).length;
  document.getElementById('resume-meta').textContent=`${d.players.join(', ')} ¬∑ ${scored}/${d.games.length} games scored ¬∑ saved ${date} by ${d.savedBy}`;
  document.getElementById('resume-banner').style.display='block';
}

function resumeDraft() {
  if (!githubData||!githubData.draft) return;
  const d=githubData.draft;
  state.players=d.players; state.numPlayers=d.numPlayers; state.games=d.games; state.scores=d.scores||{}; state.sessionId=d.sessionId||null;
  saveLocal(); document.getElementById('resume-banner').style.display='none';
  showGamesPanel(); renderGames(); toast('Session resumed! ‚úì','success');
}

async function discardDraft() {
  document.getElementById('resume-banner').style.display='none';
  if (!githubData) return;
  githubData.draft=null; await githubPut(githubData); toast('Draft discarded');
}

// ---- HISTORY ----
async function loadHistory() {
  const data=await githubGet();
  if (!data) { document.getElementById('history-content').innerHTML=`<div class="empty"><h3>Could not load</h3><p>Check the token/repo config in the HTML file</p></div>`; return; }
  githubData=data;
  renderHistoryList(data.sessions||[]);
  if (!state.games.length) checkForDraft(data);
}

function renderHistoryList(sessions) {
  const el=document.getElementById('history-content');
  if (!sessions.length) { el.innerHTML=`<div class="empty"><h3>No sessions yet</h3><p>Play and save your first session!</p></div>`; return; }
  el.innerHTML=sessions.map(s=>{
    const winner=s.leaderboard&&s.leaderboard[0];
    const scored=Object.values(s.scores||{}).filter(sc=>{const[a,b]=sc.split(':');return a!==''&&b!=='';}).length;
    return `<div class="history-card" onclick="showSessionDetail('${s.id}')">
      <div class="flex-between">
        <div class="history-date">${formatDate(s.date)}</div>
        <div style="display:flex;gap:6px;align-items:center">${s.label?`<span class="session-label">${s.label}</span>`:''}<span class="chip">${s.numPlayers}P</span></div>
      </div>
      <div class="history-meta">Saved by ${s.savedBy} ¬∑ ${scored}/${s.games?s.games.length:15} games scored</div>
      <div class="history-players">${(s.players||[]).map(p=>`<span class="player-chip">${p}</span>`).join('')}</div>
      ${winner?`<div class="history-winner">üèÜ ${winner.name} ¬∑ ${winner.pts} pts</div>`:''}
    </div>`;
  }).join('');
}

function showSessionDetail(id) {
  const s=githubData.sessions.find(x=>x.id===id); if (!s) return;
  const doubles=s.doublesLeaderboard||[];
  document.getElementById('history-detail-content').innerHTML=`
    <div class="modal-title">${formatDate(s.date)}${s.label?' ¬∑ '+s.label:''}</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px">Saved by ${s.savedBy}</p>
    <div class="lb-section-title">üë§ Individual</div>
    ${(s.leaderboard||[]).map((p,i)=>`<div class="lb-row"><div class="lb-rank">${i+1}</div><div class="lb-info"><div class="lb-name">${p.name}</div><div class="lb-sub">${p.played} games ¬∑ avg ${p.avg} ¬∑ diff ${p.diff>0?'+':''}${p.diff}</div></div><div><div class="lb-pts">${p.pts}</div><div class="lb-pts-label">pts</div></div></div>`).join('')}
    ${doubles.length?`<div class="lb-section-title">ü§ù Doubles</div>${doubles.map((d,i)=>`<div class="lb-row"><div class="lb-rank">${i+1}</div><div class="lb-info"><div class="lb-name">${d.pair}</div><div class="lb-sub">${d.played} games ¬∑ avg ${d.avgPts} pts/game ¬∑ diff ${d.diff>0?'+':''}${d.diff}</div></div><div><div class="lb-pts">${d.pts}</div><div class="lb-pts-label">pts</div></div></div>`).join('')}`:''}`;
  openModal('history-overlay');
}

// ---- CSV EXPORT ----
function exportCSV() {
  if (state.games.length===0) { toast('No games to export','error'); return; }
  const headers=['Game ID','Date','Time','Double 1 Player A','Double 1 Player B','Double 2 Player A','Double 2 Player B','Resting Player','Score','Double 1 Points','Double 2 Points',...state.players.map(p=>`${p} Pts`)];
  const now=new Date();
  const rows=state.games.map(game=>{
    const sc=state.scores[game.id]||'0:0';
    const [sA,sB]=sc.split(':').map(Number);
    const pp={}; state.players.forEach(p=>pp[p]=0);
    if(state.scores[game.id]){game.doubleA.forEach(p=>pp[p]=(pp[p]||0)+(sA||0));game.doubleB.forEach(p=>pp[p]=(pp[p]||0)+(sB||0));}
    return [game.id,now.toLocaleDateString('en-CA'),now.toLocaleTimeString(),game.doubleA[0],game.doubleA[1],game.doubleB[0],game.doubleB[1],game.resting||'',sc,sA||0,sB||0,...state.players.map(p=>pp[p]||0)];
  });
  let csv='data:text/csv;charset=utf-8,'+headers.map(h=>`"${h}"`).join(',')+'\n';
  rows.forEach(r=>{csv+=r.map(v=>`"${v}"`).join(',')+'\n';});
  const link=document.createElement('a');
  link.setAttribute('href',encodeURI(csv));
  link.setAttribute('download',`padel-${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
  toast('CSV exported ‚úì','success');
}

// ---- MISC ----
function switchTab(name) {
  ['today','board','history'].forEach(t=>{
    document.getElementById(`view-${t}`).style.display=t===name?'block':'none';
    document.getElementById(`tab-${t}`).classList.toggle('active',t===name);
  });
  if(name==='board') renderBoard();
  if(name==='history'&&githubData) renderHistoryList(githubData.sessions||[]);
}

function saveLocal() { localStorage.setItem('padel_session',JSON.stringify(state)); }

function confirmReset() { openModal('reset-overlay'); }
function doReset() {
  localStorage.removeItem('padel_session');
  Object.assign(state,{games:[],scores:{},players:[],sessionId:null});
  document.getElementById('setup-panel').style.display='block';
  document.getElementById('games-panel').style.display='none';
  document.getElementById('player-names').value='';
  if(githubData) checkForDraft(githubData);
  closeModal('reset-overlay'); toast('Session reset');
}

function openModal(id)  { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

let toastTimer;
function toast(msg,type='') {
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`toast show ${type}`;
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),type==='error'?5000:3000);
}

function formatDate(iso) {
  const d=new Date(iso+'T12:00:00');
  return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'long',year:'numeric'});
}
</script>
</body>
</html>
